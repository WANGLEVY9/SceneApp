import { CheckinApi, LikeCheckinRequest, SubmitCheckinRequest } from '../api/checkinApi';
import { CheckinRecord, CheckinSpot } from '../models/spot';
import { promptAction } from '@kit.ArkUI';
import filePicker from '@ohos.file.picker';

@Component
export struct Photo {
  @State checkinRecordList: CheckinRecord[] = []
  @State checkinSpotList: CheckinSpot[] = []
  @State loading: boolean = false
  @State showCheckinDialog: boolean = false
  @State selectedSpot: CheckinSpot | null = null
  @State checkinRemark: string = ''
  @State checkinImage: string = ''
  @State likedRecords: Set<string> = new Set()
  
  // æ˜¾ç¤ºæç¤ºä¿¡æ¯
  showToast(message: string): void {
    promptAction.showToast({
      message: message,
      duration: 2000
    });
  }
  
  // åŠ è½½æ‰“å¡è®°å½•åˆ—è¡¨
  async loadCheckinRecords(): Promise<void> {
    if (this.loading) {
      return
    }
    
    this.loading = true
    try {
      const result = await CheckinApi.getPersonalRecords({ page: 1, size: 50 })
      this.checkinRecordList = result.list || []
    } catch (e) {
      this.showToast('åŠ è½½æ‰“å¡è®°å½•å¤±è´¥')
      console.error('åŠ è½½æ‰“å¡è®°å½•å¤±è´¥:', e)
    } finally {
      this.loading = false
    }
  }
  
  // åŠ è½½æ‰“å¡ç‚¹åˆ—è¡¨
  async loadCheckinSpots(): Promise<void> {
    try {
      const spots = await CheckinApi.getCheckinSpots()
      this.checkinSpotList = spots || []
    } catch (e) {
      this.showToast('åŠ è½½æ‰“å¡ç‚¹å¤±è´¥')
      console.error('åŠ è½½æ‰“å¡ç‚¹å¤±è´¥:', e)
    }
  }
  
  // é€‰æ‹©å›¾ç‰‡
  async selectImage(): Promise<void> {
    try {
      const options = new filePicker.PhotoSelectOptions();
      options.MIMEType = filePicker.PhotoViewMIMETypes.IMAGE_TYPE;
      options.maxSelectNumber = 1;
      const picker = new filePicker.PhotoViewPicker();
      const result = await picker.select(options);
      if (result && result.photoUris && result.photoUris.length > 0) {
        this.checkinImage = result.photoUris[0];
      }
    } catch (e) {
      this.showToast('é€‰æ‹©å›¾ç‰‡å¤±è´¥')
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', e)
    }
  }
  
  // æäº¤æ‰“å¡
  async submitCheckin(): Promise<void> {
    if (!this.selectedSpot) {
      this.showToast('è¯·é€‰æ‹©æ‰“å¡ç‚¹')
      return
    }
    
    if (!this.checkinImage) {
      this.showToast('è¯·ä¸Šä¼ æ‰“å¡å›¾ç‰‡')
      return
    }
    
    // æ¨¡æ‹Ÿå®šä½ï¼šç›´æ¥ä½¿ç”¨æ‰€é€‰æ‰“å¡ç‚¹çš„ç»çº¬åº¦ï¼Œé¿å…è·ç¦»æ ¡éªŒå¤±è´¥
    const lat = this.selectedSpot.location?.lat ?? this.selectedSpot.lat
    const lng = this.selectedSpot.location?.lng ?? this.selectedSpot.lng

    if (lat === undefined || lng === undefined) {
      this.showToast('æ‰“å¡ç‚¹ç¼ºå°‘ä½ç½®ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•')
      return
    }
    
    try {
      const request: SubmitCheckinRequest = {
        spotId: this.selectedSpot.id,
        image: this.checkinImage,
        remark: this.checkinRemark,
        location: {
          lat: lat,
          lng: lng
        }
      }
      await CheckinApi.submitCheckin(request)
      
      this.showToast('æ‰“å¡æˆåŠŸ')
      this.showCheckinDialog = false
      this.selectedSpot = null
      this.checkinRemark = ''
      this.checkinImage = ''
      
      // é‡æ–°åŠ è½½æ‰“å¡è®°å½•
      this.loadCheckinRecords()
    } catch (e) {
      this.showToast('æ‰“å¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      console.error('æ‰“å¡å¤±è´¥:', e)
    }
  }
  
  // ç‚¹èµ/å–æ¶ˆç‚¹èµ
  async toggleLike(record: CheckinRecord): Promise<void> {
    const isLiked = this.likedRecords.has(record.id)
    
    try {
      const request: LikeCheckinRequest = { recordId: record.id }
      const result = await CheckinApi.likeCheckin(request)
      
      if (result.liked) {
        this.likedRecords.add(record.id)
      } else {
        this.likedRecords.delete(record.id)
      }
      record.likeCount = result.likeCount
    } catch (e) {
      this.showToast('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:', e)
    }
  }
  
  // æ‰“å¡è®°å½•å¡ç‰‡æ„å»ºå™¨
  @Builder
  CheckinCardBuilder(record: CheckinRecord) {
    Column({ space: 12 }) {
      // ç”¨æˆ·ä¿¡æ¯
      Row({ space: 8 }) {
        Column()
          .width(40)
          .height(40)
          .backgroundColor('#E0E0E0')
          .borderRadius(20)
        
        Column({ space: 4 }) {
              Text(record.userName || record.nickname || 'åŒ¿åç”¨æˆ·')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.Black)
          
          Text(record.checkinTime || record.time || '')
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      
      // æ‰“å¡ç‚¹åç§°
      Text(`ğŸ“ ${record.spotName}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#0A59F7')
        .width('100%')
      
      // æ‰“å¡å›¾ç‰‡
      if (record.image) {
        Image(record.image)
          .width('100%')
          .height(200)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
      } else {
        Column()
          .width('100%')
          .height(200)
          .backgroundColor('#E0E0E0')
          .borderRadius(8)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
      }
      
      // æ‰“å¡å¤‡æ³¨æˆ–å†…å®¹
      if (record.remark || record.content) {
        Text(record.remark || record.content || '')
          .fontSize(14)
          .fontColor('#666666')
          .width('100%')
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      
      // æ“ä½œæ 
      Row({ space: 16 }) {
        Row({ space: 4 }) {
          Image($r('app.media.camera'))
            .width(20)
            .height(20)
            .fillColor(this.likedRecords.has(record.id) ? '#FF6B00' : '#999999')
          
          Text(`${record.likeCount}`)
            .fontSize(14)
            .fontColor(this.likedRecords.has(record.id) ? '#FF6B00' : '#666666')
        }
        .onClick(() => {
          this.toggleLike(record)
        })
        
        if (record.lat && record.lng) {
          Text(`ä½ç½®: ${record.lat.toFixed(4)}, ${record.lng.toFixed(4)}`)
            .fontSize(12)
            .fontColor('#999999')
            .layoutWeight(1)
        } else {
          Blank()
            .layoutWeight(1)
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({ radius: 2, color: '#000000', offsetX: 0, offsetY: 1 })
  }
  
  // æ‰“å¡å¯¹è¯æ¡†æ„å»ºå™¨
  @Builder
  CheckinDialogBuilder() {
    if (this.showCheckinDialog) {
      Column({ space: 16 }) {
        // æ ‡é¢˜
        Row() {
          Text('é€‰æ‹©æ‰“å¡ç‚¹')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
          
          Image($r('app.media.camera'))
            .width(24)
            .height(24)
            .fillColor('#999999')
            .onClick(() => {
              this.showCheckinDialog = false
            })
        }
        .width('100%')
        
        // æ‰“å¡ç‚¹é€‰æ‹©
        if (this.checkinSpotList.length === 0) {
          Column() {
            Text('æš‚æ— æ‰“å¡ç‚¹')
              .fontSize(14)
              .fontColor('#999999')
          }
          .width('100%')
          .padding(20)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          Scroll() {
            Column({ space: 8 }) {
              ForEach(this.checkinSpotList, (spot: CheckinSpot) => {
                Row({ space: 12 }) {
                  Column()
                    .width(50)
                    .height(50)
                    .backgroundColor('#E0E0E0')
                    .borderRadius(8)
                  
                  Column({ space: 4 }) {
                    Text(spot.name)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(Color.Black)
                    
                    if (spot.hot !== undefined) {
                      Text(`çƒ­åº¦: ${spot.hot}`)
                        .fontSize(12)
                        .fontColor('#666666')
                    }
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding(12)
                .backgroundColor(this.selectedSpot?.id === spot.id ? '#E3F2FD' : Color.White)
                .borderRadius(8)
                .onClick(() => {
                  this.selectedSpot = spot
                })
              })
            }
            .width('100%')
          }
          .height(200)
          .scrollable(ScrollDirection.Vertical)
        }
        
        // å¤‡æ³¨è¾“å…¥
        TextArea({ placeholder: 'æ·»åŠ æ‰“å¡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰' })
          .width('100%')
          .height(80)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onChange((value: string) => {
            this.checkinRemark = value
          })
        
        // å›¾ç‰‡é€‰æ‹©
        Row({ space: 12 }) {
          if (this.checkinImage) {
            Image(this.checkinImage)
              .width(80)
              .height(80)
              .borderRadius(8)
              .objectFit(ImageFit.Cover)
          } else {
            Column({ space: 4 }) {
              Image($r('app.media.camera'))
                .width(32)
                .height(32)
                .fillColor('#999999')
              
              Text('æ·»åŠ å›¾ç‰‡')
                .fontSize(12)
                .fontColor('#999999')
            }
            .width(80)
            .height(80)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          }
        }
        .width('100%')
        .onClick(() => {
          this.selectImage()
        })
        
        // æäº¤æŒ‰é’®
        Button('æäº¤æ‰“å¡')
          .width('100%')
          .height(44)
          .backgroundColor('#0A59F7')
          .fontColor(Color.White)
          .borderRadius(8)
          .onClick(() => {
            this.submitCheckin()
          })
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({ radius: 10, color: '#000000', offsetX: 0, offsetY: 2 })
    }
  }
  
  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ“ä½œæ 
        Row({ space: 12 }) {
          Text('æ‰“å¡è®°å½•')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
          
          Button('+ æ‰“å¡')
            .fontSize(14)
            .backgroundColor('#0A59F7')
            .fontColor(Color.White)
            .borderRadius(20)
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              this.showCheckinDialog = true
              if (this.checkinSpotList.length === 0) {
                this.loadCheckinSpots()
              }
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor(Color.White)
        
        // æ‰“å¡è®°å½•åˆ—è¡¨
        if (this.loading) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#0A59F7')
            
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          Scroll() {
            Column() {
              if (this.checkinRecordList.length === 0) {
                Column() {
                  Text('æš‚æ— æ‰“å¡è®°å½•')
                    .fontSize(14)
                    .fontColor('#999999')
                  
                  Button('å»æ‰“å¡')
                    .margin({ top: 16 })
                    .backgroundColor('#0A59F7')
                    .fontColor(Color.White)
                    .borderRadius(20)
                    .onClick(() => {
                      this.showCheckinDialog = true
                      if (this.checkinSpotList.length === 0) {
                        this.loadCheckinSpots()
                      }
                    })
                }
                .width('100%')
                .padding(40)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              } else {
                ForEach(this.checkinRecordList, (record: CheckinRecord) => {
                  this.CheckinCardBuilder(record)
                })
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          }
          .width('100%')
          .layoutWeight(1)
          .scrollable(ScrollDirection.Vertical)
          .scrollBar(BarState.Auto)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
      
      // æ‰“å¡å¯¹è¯æ¡†
      if (this.showCheckinDialog) {
        Column() {
          Blank()
          
          this.CheckinDialogBuilder()
          
          Blank()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showCheckinDialog = false
        })
      }
    }
    .width('100%')
    .height('100%')
    .onAppear(() => {
      this.loadCheckinRecords()
    })
  }
}
